<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAHR LAB - AI Text Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #f8f9fa;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
            margin-bottom: 30px;
        }
        
        .logo {
            cursor: pointer;
            height: 27px;
        }
        
        .main-title {
            font-size: 32px;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
        .create-container, .editor-container {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        /* –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ */
        .creation-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .option-card {
            padding: 20px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-card:hover, .option-card.active {
            border-color: #000;
            background: #f8f9fa;
        }
        
        .option-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #000;
        }
        
        .option-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        .prompt-input {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            margin-bottom: 15px;
            min-height: 100px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        .prompt-input:focus {
            outline: none;
            border-color: #000;
        }
        
        .generate-button {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            background: #000;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .generate-button:hover {
            background: #333;
        }
        
        /* –†–µ–¥–∞–∫—Ç–æ—Ä */
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .tool-button {
            padding: 10px 16px;
            background: white;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .tool-button:hover {
            border-color: #000;
            background: #f8f9fa;
        }
        
        .tool-button.active {
            background: #000;
            color: white;
            border-color: #000;
        }
        
        .editor-area {
            width: 100%;
            min-height: 300px;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            border: 2px solid #eaeaea;
            border-radius: 12px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        .editor-area:focus {
            outline: none;
            border-color: #000;
        }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .edit-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            padding: 30px;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1000;
        }
        
        .edit-panel.active {
            transform: translateX(0);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .panel-title {
            font-size: 20px;
            font-weight: 600;
            color: #000;
        }
        
        .close-panel {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .edit-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .edit-option {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .edit-option:hover {
            border-color: #000;
            background: white;
        }
        
        .edit-option-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #000;
        }
        
        .edit-option-desc {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        /* –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π —Å —Ç–µ–∫—Å—Ç–æ–º */
        .actions-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
        }
        
        .action-button {
            padding: 12px 24px;
            background: white;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .action-button:hover {
            border-color: #000;
        }
        
        .action-button.primary {
            background: #000;
            color: white;
            border-color: #000;
        }
        
        .action-button.primary:hover {
            background: #333;
        }
        
        /* –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-box {
            background: #fff3f3;
            border: 2px solid #ffcccc;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }
        
        .retry-button {
            margin-top: 15px;
            padding: 10px 25px;
            background: #000;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #000;
        }
        
        .keywords-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .keywords-input:focus {
            outline: none;
            border-color: #000;
        }
        
        .keyword-tag {
            display: inline-block;
            background: #f0f0f0;
            padding: 6px 12px;
            border-radius: 20px;
            margin: 5px;
            font-size: 14px;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .create-container,
            .editor-container {
                padding: 20px;
            }
            
            .creation-options {
                grid-template-columns: 1fr;
            }
            
            .edit-panel {
                width: 100%;
            }
            
            .editor-toolbar {
                justify-content: center;
            }
            
            .actions-panel {
                justify-content: center;
            }
        }
        
        /* –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç */
        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #ffeaa7;
        }
        
        .highlight.active {
            background: #4dabf7;
            color: white;
            border-color: #1971c2;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://raw.githubusercontent.com/bahrlab/bahrlab.github.io/refs/heads/main/files/images/BAHRLABLOGO.png" alt="BAHR LAB" class="logo" onclick="goHome()">
    </div>
    
    <div id="homePage">
        <h1 class="main-title">AI Text Editor</h1>
        <p class="subtitle">Create, edit, and perfect your text with AI assistance</p>
        
        <div class="create-container">
            <h2 style="font-size: 24px; margin-bottom: 20px; color: #000;">Create Text</h2>
            
            <div class="creation-options">
                <div class="option-card active" onclick="setCreationMode('ai')" id="aiOption">
                    <div class="option-title">‚ú® AI Generation</div>
                    <div class="option-desc">Generate text on any topic using artificial intelligence</div>
                </div>
                <div class="option-card" onclick="setCreationMode('paste')" id="pasteOption">
                    <div class="option-title">üìù Paste Text</div>
                    <div class="option-desc">Insert your own text for editing and improvement</div>
                </div>
            </div>
            
            <div id="aiPromptSection">
                <textarea class="prompt-input" id="aiPrompt" placeholder="Describe what text you want to create. For example: 'A short story about space exploration', 'Professional email to a client', 'Creative product description for a smartphone'"></textarea>
                <button class="generate-button" onclick="generateText()">Generate Text with AI</button>
            </div>
            
            <div id="pasteSection" style="display: none;">
                <textarea class="prompt-input" id="pasteText" placeholder="Paste your text here..."></textarea>
                <button class="generate-button" onclick="loadPastedText()">Load Text for Editing</button>
            </div>
        </div>
        
        <div class="loading" id="loadingSection" style="display: none;">
            <div class="loading-spinner"></div>
            <div style="font-size: 18px; margin-top: 20px;">AI is creating your text...</div>
        </div>
        
        <div class="error-box" id="errorSection" style="display: none;">
            <h3>Unable to generate text</h3>
            <p>The AI is currently experiencing high load. Please try again.</p>
            <button class="retry-button" onclick="retryGeneration()">Retry</button>
        </div>
    </div>
    
    <div id="editorPage" style="display: none;">
        <div class="editor-container">
            <div class="editor-toolbar">
                <button class="tool-button" onclick="selectText()" id="selectBtn">
                    <span>üîç</span> Select Text
                </button>
                <button class="tool-button" onclick="openEditPanel()" id="editBtn">
                    <span>‚úèÔ∏è</span> Edit Selection
                </button>
                <button class="tool-button" onclick="transformEntireText('simplify')">
                    <span>üìù</span> Simplify Text
                </button>
                <button class="tool-button" onclick="transformEntireText('formal')">
                    <span>üëî</span> Make Formal
                </button>
                <button class="tool-button" onclick="transformEntireText('creative')">
                    <span>üé®</span> Make Creative
                </button>
                <button class="tool-button" onclick="openKeywordsModal()">
                    <span>üîë</span> Add Keywords
                </button>
                <button class="tool-button" onclick="openLengthModal()">
                    <span>üìè</span> Change Length
                </button>
            </div>
            
            <textarea class="editor-area" id="textEditor" placeholder="Your text will appear here..."></textarea>
            
            <div class="actions-panel">
                <button class="action-button" onclick="copyText()">
                    <span>üìã</span> Copy Text
                </button>
                <button class="action-button" onclick="downloadText()">
                    <span>üíæ</span> Download as .txt
                </button>
                <button class="action-button" onclick="clearEditor()">
                    <span>üóëÔ∏è</span> Clear All
                </button>
                <button class="action-button primary" onclick="createNew()">
                    <span>üÜï</span> Create New Text
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ -->
    <div class="edit-panel" id="editPanel">
        <div class="panel-header">
            <div class="panel-title">Edit Selection</div>
            <button class="close-panel" onclick="closeEditPanel()">√ó</button>
        </div>
        
        <div id="selectedTextPreview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-style: italic;">
            No text selected
        </div>
        
        <div class="edit-options">
            <div class="edit-option" onclick="applyEdit('simplify')">
                <div class="edit-option-title">üîß Simplify</div>
                <div class="edit-option-desc">Make the selected text simpler and easier to understand</div>
            </div>
            
            <div class="edit-option" onclick="applyEdit('explain')">
                <div class="edit-option-title">üìö Explain Meaning</div>
                <div class="edit-option-desc">Add explanation or definition for selected terms</div>
            </div>
            
            <div class="edit-option" onclick="applyEdit('rephrase')">
                <div class="edit-option-title">üîÑ Rephrase</div>
                <div class="edit-option-desc">Say the same thing in different words</div>
            </div>
            
            <div class="edit-option" onclick="applyEdit('formal')">
                <div class="edit-option-title">üëî Make Formal</div>
                <div class="edit-option-desc">Make the text more professional and formal</div>
            </div>
            
            <div class="edit-option" onclick="applyEdit('casual')">
                <div class="edit-option-title">üòä Make Casual</div>
                <div class="edit-option-desc">Make the text more conversational and friendly</div>
            </div>
            
            <div class="edit-option" onclick="applyEdit('expand')">
                <div class="edit-option-title">‚ûï Expand</div>
                <div class="edit-option-desc">Add more details and explanations</div>
            </div>
            
            <div class="edit-option" onclick="applyEdit('shorten')">
                <div class="edit-option-title">‚ûñ Shorten</div>
                <div class="edit-option-desc">Make the text more concise</div>
            </div>
            
            <div class="edit-option" onclick="applyEdit('remove')">
                <div class="edit-option-title">üóëÔ∏è Remove</div>
                <div class="edit-option-desc">Delete the selected text completely</div>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <textarea class="prompt-input" id="customEditPrompt" placeholder="Or describe exactly what change you want to make..." style="min-height: 80px;"></textarea>
            <button class="generate-button" onclick="applyCustomEdit()">Apply Custom Edit</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ -->
    <div class="modal-overlay" id="keywordsModal">
        <div class="modal">
            <div class="modal-title">Add Keywords</div>
            <p style="margin-bottom: 15px; color: #666;">Enter keywords that must be included in the text. Separate with commas.</p>
            <input type="text" class="keywords-input" id="keywordsInput" placeholder="e.g., innovation, technology, future, AI">
            <div id="keywordsPreview" style="margin-bottom: 20px;"></div>
            <button class="generate-button" onclick="applyKeywords()">Add Keywords to Text</button>
            <button class="tool-button" style="margin-top: 10px; width: 100%;" onclick="closeModal('keywordsModal')">Cancel</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª–∏–Ω—ã -->
    <div class="modal-overlay" id="lengthModal">
        <div class="modal">
            <div class="modal-title">Change Text Length</div>
            <p style="margin-bottom: 20px; color: #666;">Adjust the length of your entire text.</p>
            
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <button class="edit-option" onclick="changeLength('shorter')">
                    <div class="edit-option-title">‚ûñ Make Shorter</div>
                    <div class="edit-option-desc">Reduce length by 50%</div>
                </button>
                
                <button class="edit-option" onclick="changeLength('slightly_shorter')">
                    <div class="edit-option-title">üìâ Make Slightly Shorter</div>
                    <div class="edit-option-desc">Reduce length by 25%</div>
                </button>
                
                <button class="edit-option" onclick="changeLength('longer')">
                    <div class="edit-option-title">‚ûï Make Longer</div>
                    <div class="edit-option-desc">Increase length by 50%</div>
                </button>
                
                <button class="edit-option" onclick="changeLength('slightly_longer')">
                    <div class="edit-option-title">üìà Make Slightly Longer</div>
                    <div class="edit-option-desc">Increase length by 25%</div>
                </button>
            </div>
            
            <button class="tool-button" style="margin-top: 20px; width: 100%;" onclick="closeModal('lengthModal')">Cancel</button>
        </div>
    </div>
    
    <script>
        const API_URL = "https://freeai.logise1123.workers.dev/";
        let currentText = '';
        let selectedText = '';
        let selectionStart = 0;
        let selectionEnd = 0;
        let creationMode = 'ai';
        let selectedKeywords = [];
        
        function goHome() {
            window.location.href = "https://bahrlab.github.io/editor";
        }
        
        function setCreationMode(mode) {
            creationMode = mode;
            
            document.getElementById('aiOption').classList.remove('active');
            document.getElementById('pasteOption').classList.remove('active');
            
            if (mode === 'ai') {
                document.getElementById('aiOption').classList.add('active');
                document.getElementById('aiPromptSection').style.display = 'block';
                document.getElementById('pasteSection').style.display = 'none';
            } else {
                document.getElementById('pasteOption').classList.add('active');
                document.getElementById('aiPromptSection').style.display = 'none';
                document.getElementById('pasteSection').style.display = 'block';
            }
        }
        
        async function generateText() {
            const prompt = document.getElementById('aiPrompt').value.trim();
            if (!prompt) {
                alert('Please enter a description for your text');
                return;
            }
            
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('errorSection').style.display = 'none';
            
            try {
                const aiPrompt = `Write a text about: "${prompt}"
                
                Requirements:
                - Write in natural, flowing language
                - Appropriate length (3-5 paragraphs)
                - Include varied sentence structure
                - ${selectedKeywords.length > 0 ? 'Include these keywords: ' + selectedKeywords.join(', ') : ''}
                
                Return only the text, no explanations.`;
                
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instruct-fast',
                        messages: [{ role: 'user', content: aiPrompt }]
                    })
                });
                
                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                const aiText = data?.choices?.[0]?.message?.content || "";
                
                if (!aiText || aiText.includes('[object Object]')) {
                    throw new Error('Invalid response');
                }
                
                currentText = aiText;
                showEditor(aiText);
                
            } catch (error) {
                console.error('Error generating text:', error);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('errorSection').style.display = 'block';
            }
        }
        
        function loadPastedText() {
            const text = document.getElementById('pasteText').value.trim();
            if (!text) {
                alert('Please paste some text');
                return;
            }
            
            currentText = text;
            showEditor(text);
        }
        
        function showEditor(text) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('editorPage').style.display = 'block';
            document.getElementById('textEditor').value = text;
            
            updateTextSelection();
        }
        
        function createNew() {
            document.getElementById('editorPage').style.display = 'none';
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('aiPrompt').value = '';
            document.getElementById('pasteText').value = '';
            setCreationMode('ai');
        }
        
        function selectText() {
            const editor = document.getElementById('textEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            
            if (start === end) {
                alert('Please select some text first');
                return;
            }
            
            selectedText = editor.value.substring(start, end);
            selectionStart = start;
            selectionEnd = end;
            
            document.getElementById('selectedTextPreview').innerHTML = 
                `<strong>Selected:</strong> "${selectedText.substring(0, 100)}${selectedText.length > 100 ? '...' : ''}"`;
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            const textBefore = editor.value.substring(0, start);
            const textSelected = editor.value.substring(start, end);
            const textAfter = editor.value.substring(end);
            
            // –í —Ç–µ–∫—Å—Ç–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏ –Ω–µ–ª—å–∑—è —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ –≤ preview
            document.getElementById('selectBtn').classList.add('active');
            document.getElementById('editBtn').classList.remove('disabled');
        }
        
        function updateTextSelection() {
            const editor = document.getElementById('textEditor');
            editor.addEventListener('mouseup', function() {
                const start = this.selectionStart;
                const end = this.selectionEnd;
                
                if (start !== end) {
                    selectedText = this.value.substring(start, end);
                    selectionStart = start;
                    selectionEnd = end;
                    
                    document.getElementById('selectedTextPreview').innerHTML = 
                        `<strong>Selected:</strong> "${selectedText.substring(0, 100)}${selectedText.length > 100 ? '...' : ''}"`;
                }
            });
        }
        
        function openEditPanel() {
            if (!selectedText) {
                alert('Please select some text first');
                return;
            }
            
            document.getElementById('editPanel').classList.add('active');
        }
        
        function closeEditPanel() {
            document.getElementById('editPanel').classList.remove('active');
        }
        
        async function applyEdit(action) {
            if (!selectedText) return;
            
            const editor = document.getElementById('textEditor');
            const fullText = editor.value;
            
            let instruction = '';
            switch(action) {
                case 'simplify':
                    instruction = `Simplify this text to make it easier to understand: "${selectedText}"`;
                    break;
                case 'explain':
                    instruction = `Explain the meaning of this text clearly: "${selectedText}"`;
                    break;
                case 'rephrase':
                    instruction = `Rephrase this text using different words: "${selectedText}"`;
                    break;
                case 'formal':
                    instruction = `Make this text more formal and professional: "${selectedText}"`;
                    break;
                case 'casual':
                    instruction = `Make this text more casual and conversational: "${selectedText}"`;
                    break;
                case 'expand':
                    instruction = `Expand this text with more details: "${selectedText}"`;
                    break;
                case 'shorten':
                    instruction = `Make this text more concise: "${selectedText}"`;
                    break;
                case 'remove':
                    // –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                    const newText = fullText.substring(0, selectionStart) + fullText.substring(selectionEnd);
                    editor.value = newText;
                    currentText = newText;
                    selectedText = '';
                    closeEditPanel();
                    return;
            }
            
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instruct-fast',
                        messages: [{ role: 'user', content: instruction }]
                    })
                });
                
                const data = await response.json();
                const newText = data?.choices?.[0]?.message?.content || selectedText;
                
                // –ó–∞–º–µ–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –Ω–æ–≤—ã–π
                const updatedText = fullText.substring(0, selectionStart) + 
                                   newText + 
                                   fullText.substring(selectionEnd);
                
                editor.value = updatedText;
                currentText = updatedText;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤—ã–¥–µ–ª–µ–Ω–∏—è
                selectionEnd = selectionStart + newText.length;
                selectedText = newText;
                
                closeEditPanel();
                
            } catch (error) {
                console.error('Edit error:', error);
                alert('Error applying edit. Please try again.');
            }
        }
        
        async function applyCustomEdit() {
            const customPrompt = document.getElementById('customEditPrompt').value.trim();
            if (!customPrompt || !selectedText) return;
            
            const instruction = `Regarding this text: "${selectedText}"
            
            Please do this: ${customPrompt}
            
            Return only the modified text.`;
            
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instruct-fast',
                        messages: [{ role: 'user', content: instruction }]
                    })
                });
                
                const data = await response.json();
                const newText = data?.choices?.[0]?.message?.content || selectedText;
                
                const editor = document.getElementById('textEditor');
                const fullText = editor.value;
                const updatedText = fullText.substring(0, selectionStart) + 
                                   newText + 
                                   fullText.substring(selectionEnd);
                
                editor.value = updatedText;
                currentText = updatedText;
                
                document.getElementById('customEditPrompt').value = '';
                closeEditPanel();
                
            } catch (error) {
                console.error('Custom edit error:', error);
                alert('Error applying custom edit.');
            }
        }
        
        async function transformEntireText(style) {
            const editor = document.getElementById('textEditor');
            const text = editor.value;
            
            if (!text.trim()) {
                alert('Please enter some text first');
                return;
            }
            
            let instruction = '';
            switch(style) {
                case 'simplify':
                    instruction = `Simplify this entire text to make it easier to understand:\n\n${text}`;
                    break;
                case 'formal':
                    instruction = `Rewrite this text in a more formal and professional style:\n\n${text}`;
                    break;
                case 'creative':
                    instruction = `Make this text more creative and engaging:\n\n${text}`;
                    break;
            }
            
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instruct-fast',
                        messages: [{ role: 'user', content: instruction }]
                    })
                });
                
                const data = await response.json();
                const newText = data?.choices?.[0]?.message?.content || text;
                
                editor.value = newText;
                currentText = newText;
                
            } catch (error) {
                console.error('Transform error:', error);
                alert('Error transforming text.');
            }
        }
        
        function openKeywordsModal() {
            document.getElementById('keywordsModal').classList.add('active');
            updateKeywordsPreview();
        }
        
        function updateKeywordsPreview() {
            const preview = document.getElementById('keywordsPreview');
            if (selectedKeywords.length === 0) {
                preview.innerHTML = '<em>No keywords added yet</em>';
            } else {
                preview.innerHTML = selectedKeywords.map(keyword => 
                    `<span class="keyword-tag">${keyword}</span>`
                ).join('');
            }
        }
        
        function applyKeywords() {
            const input = document.getElementById('keywordsInput').value.trim();
            if (input) {
                const newKeywords = input.split(',').map(k => k.trim()).filter(k => k);
                selectedKeywords = [...new Set([...selectedKeywords, ...newKeywords])];
                document.getElementById('keywordsInput').value = '';
                updateKeywordsPreview();
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∫ —Ç–µ–∫—Å—Ç—É
            const editor = document.getElementById('textEditor');
            const text = editor.value;
            
            if (selectedKeywords.length > 0 && text) {
                const keywordInstruction = `Rewrite this text to naturally include these keywords: ${selectedKeywords.join(', ')}\n\nText to modify:\n${text}`;
                
                fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instruct-fast',
                        messages: [{ role: 'user', content: keywordInstruction }]
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const newText = data?.choices?.[0]?.message?.content;
                    if (newText) {
                        editor.value = newText;
                        currentText = newText;
                    }
                    closeModal('keywordsModal');
                })
                .catch(error => {
                    console.error('Keywords error:', error);
                    alert('Error adding keywords.');
                });
            } else {
                closeModal('keywordsModal');
            }
        }
        
        function openLengthModal() {
            document.getElementById('lengthModal').classList.add('active');
        }
        
        async function changeLength(type) {
            const editor = document.getElementById('textEditor');
            const text = editor.value;
            
            if (!text.trim()) {
                alert('Please enter some text first');
                return;
            }
            
            let instruction = '';
            switch(type) {
                case 'shorter':
                    instruction = `Make this text 50% shorter while keeping the main ideas:\n\n${text}`;
                    break;
                case 'slightly_shorter':
                    instruction = `Make this text 25% shorter:\n\n${text}`;
                    break;
                case 'longer':
                    instruction = `Expand this text to be 50% longer, adding relevant details:\n\n${text}`;
                    break;
                case 'slightly_longer':
                    instruction = `Make this text 25% longer:\n\n${text}`;
                    break;
            }
            
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instruct-fast',
                        messages: [{ role: 'user', content: instruction }]
                    })
                });
                
                const data = await response.json();
                const newText = data?.choices?.[0]?.message?.content || text;
                
                editor.value = newText;
                currentText = newText;
                
                closeModal('lengthModal');
                
            } catch (error) {
                console.error('Length change error:', error);
                alert('Error changing text length.');
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function copyText() {
            const text = document.getElementById('textEditor').value;
            navigator.clipboard.writeText(text).then(() => {
                alert('Text copied to clipboard!');
            });
        }
        
        function downloadText() {
            const text = document.getElementById('textEditor').value;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bahrlab-text.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function clearEditor() {
            if (confirm('Are you sure you want to clear all text?')) {
                document.getElementById('textEditor').value = '';
                currentText = '';
                selectedText = '';
            }
        }
        
        function retryGeneration() {
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('homePage').style.display = 'block';
        }
        
        function checkUrlForPrompt() {
            const urlParams = new URLSearchParams(window.location.search);
            const prompt = urlParams.get('p');
            const text = urlParams.get('text');
            
            if (prompt) {
                document.getElementById('aiPrompt').value = prompt;
                generateText();
            } else if (text) {
                document.getElementById('pasteText').value = decodeURIComponent(text);
                setCreationMode('paste');
                loadPastedText();
            } else {
                document.getElementById('homePage').style.display = 'block';
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
        document.addEventListener('click', function(event) {
            const editPanel = document.getElementById('editPanel');
            if (editPanel.classList.contains('active') && 
                !editPanel.contains(event.target) && 
                !event.target.closest('.tool-button')) {
                closeEditPanel();
            }
        });
        
        window.onload = function() {
            checkUrlForPrompt();
            document.getElementById('aiPrompt').focus();
        };
    </script>
</body>
</html>